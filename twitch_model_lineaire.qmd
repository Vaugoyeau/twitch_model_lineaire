---
title: "S√©lection d'un mod√®le lin√©aire"
author: "Marie Vaugoyeau"
date: "2025/01/21"
date-format: "D MMMM YYYY"
format: 
  pdf:
    toc: true
    number-sections: true
    papersize: letter
execute: 
  warning: false
---

# import des packages  
```{r}
library(tidyverse)
library(palmerpenguins)
```

# D√©finition de la `r√©gression lin√©aire`  

**Objectif** : Trouver une √©quation de type lin√©aire qui permet d'expliquer une **variable r√©ponse quantitative** par **une ou plusieurs variable(s) explicative(s)**.   

:::callout-note
## Diff√©rence entre r√©gression lin√©aire et mod√®le lin√©aire  

Il n'y en a pas !  
Certaines personnes parlent de **mod√®le de r√©gression lin√©aire**.  
:::

L'√©quation est de la forme : $$ Y = a_1X_1 + a_2X_2 + ... + a_nX_n +  b $$ 

Avec a~i~ : la pente (ou coefficient directeur) associ√© √† la variable X~i~ et b : l'ordonn√©e √† l'origine ou **intecept** (en anglais).     
 
# Les donn√©es  
Les donn√©es utilis√©es sont celles du jeu de donn√©es `penguins` du package `{palmerpenguins}`.  
Plus d'information sur la page d'aide `help(penguins)`.  
  
```{r}
penguins |> 
  glimpse()
```

# R√©alisation d'un mod√®l lin√©aire  
## 1^√®re^ √©tape : Choix des variables utilis√©es  
  
Dans cette exemple, la **variable r√©ponse** est `body_mass_g` et les **variables explicatives** sont les caract√©ristiques morphologiques mesur√©es : `bill_length_mm`, `bill_depth_mm` et `flipper_length_mm`.  
  
::: callout-note
Les donn√©es ajout√©es dans un model doit avoir un sens.  
On ne peux pas ajouter toutes les variables **juste pour voir** !  
:::

Les risques √† mettre toutes les variables possibles dans un mod√®le :  

- Impossibilit√© d'expliquer le mod√®le dans la r√©alit√© (*expl : l'√¢ge du capitaine*)  
- Sur ou sous ajustement (aussi appel√© sur ou sous apprentissage et en anglais *over or underfitting*)  
![](img/Overfitting.png)  
[@educative](https://www.educative.io/answers/overfitting-and-underfitting)  
  
Sur le graphique :  

- le sch√©ma de gauche montre un **sous-ajustement**, c'est-√†-dire que la droite ne prend pas en compte les variations des donn√©es et **simplifie trop**.  
- le sch√©ma du milieu montre un **bon ajustement** aux donn√©es.  
- le sch√©ma de droite montre un **sur-ajustement**. Le courbe ne permet pas de prendre en compte de nouvelles donn√©es.  
  
## 2^√®me^ √©tape : V√©rifier les limites de construction du mod√®le       
Les donn√©es doivent √™tre ind√©pendantes et suivre (ou √™tre approxim√©es par) des lois normales.  
  
Test de Shapiro-Wilk
```{r}
map(
  .x = penguins |> 
    select(where(is.numeric), - year),
  .f = shapiro.test
)
```
  
::: callout-note
Selon le test de Shapiro-Wilk, les donn√©es ne suivent pas des lois normales  
:::
  
Repr√©sentation graphique  
```{r}
penguins |> 
  select(
    where(is.numeric),
    - year
  ) |> 
  pivot_longer(everything()) |> 
  ggplot() +
  aes(sample = value) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ name, scales = "free") +
  theme_bw()
```
  
Ici la normalit√© est acceptable, surtout qu'il y a bien plus de 30 donn√©es.  
  
:::callout-note  
Le mod√®le lin√©aire est assez r√©sistant √† l'absence de normalit√© et il est possible de le faire en prenant en compte [**la loi des grands nombres**](https://fr.wikipedia.org/wiki/Loi_des_grands_nombres).  
:::
  
Si tu as d√©j√† un mod√®le lin√©aire, tu as d√ª entendre parler de multicolin√©arit√© (comme on m'a pos√© la question lors du [live](https://www.twitch.tv/videos/2359516372) üòä)  
  
::: callout-warning
## D√©finitions : multicolin√©arit√© ou corr√©lation   

La colin√©arit√© est une corr√©lation entre variables ind√©pendantes.  
Quand plusieurs variables sont concern√©es on parle de multicolin√©arit√©.  
:::
  
Ici il est int√©ressant de regarder la multicolin√©arit√© m√™me si elle est trait√© plus loin !  
  
```{r}
penguins |> 
  select(where(is.numeric), - year) |>
  drop_na() |> 
  cor() |> 
  corrplot::corrplot.mixed()
```
  
## 3^√®me^ √©tape : Cr√©ation du mod√®le lin√©aire  
Plusieurs packages ont des fonctions qui permettent de r√©aliser un mod√®le lin√©aire.  
Ici je vais rester sur la fonction `lm()` du package `{stats}` automatiquement charg√© dans l'environnement.  
Cette fonction prend comme premier argument la `formula`, c'est-√†-dire la formule de type `y ~ x` et en deuxi√®me argument `data`, le jeu de donn√©es utilis√©.  
```{r}
lm_body_mass <- lm(
  body_mass_g ~ bill_length_mm + bill_depth_mm + flipper_length_mm,
  data = penguins
)
```
  
Pour acc√©der aux coefficients, il y a plusieurs solutions :  

- Rappeler le nom du mod√®le : Ne donne pas les statistiques de test    
- Utiliser la fonction `summary()` du package `{base}` : Le plus complet      
  
```{r}
lm_body_mass
summary(lm_body_mass)
```

  
Pour aller plus loin :  
  
- Utilisation de la fonction `anova()` du package `{stats}` : Permet d'afficher facilement le tableau des coefficients     
- Prendre la fonction `Anova()` du package `{car}` : M√™me chose que pr√©c√©dent mais type II (et m√™me III s'il y a une interaction)    
  
```{r}
anova(lm_body_mass)
car::Anova(lm_body_mass)
```

  
## 4^√®me^ √©tape : Validation du mod√®le  
Le mod√®le est accept√© si les **r√©sidus** suivent une **loi normale**.  
  
```{r}
lm_body_mass$residuals |> 
  shapiro.test()
```
  
  
Les r√©sidus suivent une loi normale (`p-valeur` > 0.05 -> impossible de rejeter l'hypoth√®se nulle selon laquelle les donn√©es suivent une loi normale).  
  
Il est aussi bien de visualiser le mod√®le gr√¢ce √† la fonction `plot()`.  

```{r}
#| layout-ncol: 2
#| fig-cap: 
#|  - "La courbe rouge doit √™tre la plus proche de la droite en pointill√©e"
#|  - "Les points doivent suivre la premi√®re diagonale en pointill√©e"
#|  - "La courbe rouge doit √™tre la plus plate possible" 
#|  - "La courbe rouge doit √™tre proche de la droite horizontale en pointill√©e"
plot(lm_body_mass)
```
  
Et la multicolin√©arit√© ?  
```{r}
car::vif(lm_body_mass)
```
  
Il y a pas de multicolin√©arit√© lorsque les facteurs d'inflation de la variance (en anglais *variance inflation factor (VIF)*) sont √† `1`.  

  
:::callout-note  
## Influence de la multicolin√©arit√©  

Si les **FIV** sont sup√©rieurs √† 1, la variable est corr√©l√©e aux autre et son influence est "augment√©e".   
A quel valeur est-ce grave ?  
Pour [Paul ALLISON](https://statisticalhorizons.com/multicollinearity/) au del√† de `2,5` c'est un signe d'inqui√©tude. Pour d'autres personnes, c'est √† partir de `5`.  
**Mon conseil** : Simplifions le mod√®le et voyons apr√®s !  
::: 
  
  
## 5^√®me^ √©tape : S√©lection de mod√®le  
Ici, r√©alisation d'une s√©lection descendante qui revient √† supprimer les variables les moins significatives.  
  
```{r}
lm_body_mass_2 <- lm(
  body_mass_g ~ bill_depth_mm + flipper_length_mm,
  data = penguins
)

summary(lm_body_mass_2)
anova(lm_body_mass, lm_body_mass_2)
AIC(lm_body_mass, lm_body_mass_2)
```

Pour comparer deux mod√®les, j'utilise ici l'AIC.  

::: callout-note
## AIC : Crit√®re d'Information d'Akaike (en anglais *Akaike information criterion*)  
  
Permet de comparer deux mod√®les proches (m√™me donn√©es et une ou deux variables en plus ou en moins) pour choisir le plus significatif, c'est-√†-dire celui qui a la la valeur d'AIC la plus faible. 

**Attention** : si la diff√©rence est inf√©rieure √† 2, il faut faire le choix de parcimonie, c'est-√†-dire de pr√©f√©rer le mod√®le le plus simple (avec le moins de variables explicatives).  
:::
  
```{r}
lm_body_mass_3 <- lm(
  body_mass_g ~ flipper_length_mm,
  data = penguins
)

summary(lm_body_mass_3)
anova(lm_body_mass_2, lm_body_mass_3)
AIC(lm_body_mass_2, lm_body_mass_3)
```

Le mod√®le le plus simple avec juste la longueur de la nageoire serait meilleur.  


```{r}
lm_body_mass_3$residuals |> 
  shapiro.test()
```
  
Les r√©sidus suivants une loi normale, le mod√®le est valid√©.  

```{r}
#| layout-ncol: 2
#| fig-cap: 
#|  - "La courbe rouge doit √™tre la plus proche de la droite en pointill√©e"
#|  - "Les points doivent suivre la premi√®re diagonale en pointill√©e"
#|  - "La courbe rouge doit √™tre la plus plate possible" 
#|  - "La courbe rouge doit √™tre proche de la droite horizontale en pointill√©e"
plot(lm_body_mass_3)
```

Les sorties graphiques de la fonction `plot()` valide le mod√®le aussi.  

Il ne reste donc plus qu'√† valoriser le mod√®le trouv√© via un graphique.  

```{r}
ggplot(penguins) +
  aes(x = flipper_length_mm, y = body_mass_g) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_classic()
```

Sur le graphique il semble appara√Ætre "2 groupes", **un avec une nageoire de moins de 205 mm** et **un avec plus**.  
Il est possible d'explorer graphiquement cette id√©e en ajoutant l'esp√®ce en couleur.  

```{r}
ggplot(penguins) +
  aes(x = flipper_length_mm, y = body_mass_g, colour = species) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_classic()
```

Cr√©ation d'un mod√®le avec une interaction esp√®ce et longueur de la nageoire. C'est √† dire que l'esp√®ce influence le coefficient directeur associ√©e √† la longueur de la nageoire comme vu sur le graphique.  
L'interaction est repr√©sent√© par `:` mais comme les effets simples doivent √™tre pr√©sent dans le mod√®le, il faut utiliser `*` ainsi `A * B = A + B + A:B` avec `A` et `B` sont les effets simples qui ne doivent pas √™tre supprim√© du mod√®le si l'interaction est significative et `A:B` est l'interaction.  
  
```{r}
lm_body_mass_4 <- lm(
  body_mass_g ~ flipper_length_mm * species,
  data = penguins
)

summary(lm_body_mass_4)
car::Anova(lm_body_mass_4)
```

La fonction `Anova()` du package `{car}` nous permet de voir que l'interaction est significative.  

```{r}
AIC(lm_body_mass_3, lm_body_mass_4)
```
Selon l'AIC, le mod√®le avec l'interaction est beaucoup plus int√©ressant que le mod√®le simple avec que la longueur de la nageoire.  
  
Pour conna√Ætre la diff√©rence entre les esp√®ces il faut faire un test post-hoc pour effectuer une comparaison multiple, ici un test post-hoc de Tukey.  
  
::: callout-warning
## Attention  

Un test post-hoc ne se r√©alise **que** si la variable concern√©e est **significative** dans le mod√®le !  
::: 
  
```{r}
library(multcomp)

summary(glht(lm_body_mass_4, linfct = mcp(species="Tukey")))
```

::: callout-note
Pour r√©sumer, `Chinstrap` et `Adelie` sont similaires.  
`Gentoo` est significativement diff√©rent de `Adelie` (*p-valeur* < 0.01) et l√©g√®rement diff√©rent de `Chinstrap` (*p-valeur* = 0.07).  
  
Si tu as l'habitude d'utiliser les lettres, `Gentoo` est `a`, `Adelie` est `b` et `Chinstrap` est `ab`.  
:::  
  

# En savoir un peu plus sur moi  
Bonjour, 
  
Je suis Marie Vaugoyeau et je suis disponible pour des **missions en freelance** d‚Äô**accompagnement √† la formation** √† R et √† l‚Äôanalyse de donn√©es et/ou en **programmation** (reprise de scripts, bonnes pratiques de codage, d√©veloppement de package).  
Ayant un **bagage recherche en √©cologie**, j‚Äôai accompagn√© plusieurs chercheuses en biologie dans leurs analyses de donn√©es mais je suis ouverte √† d‚Äôautres domaines.  
  
Vous pouvez retrouver mes offres [ici](https://marievaugoyeau.notion.site/MStats-Marie-Vaugoyeau-d69b566c83414152ac85eae012c970fb).  
  
**En plus de mes missions de consulting je diffuse mes savoirs en R et analyse de donn√©es sur plusieurs plateformes :**   
  
- J‚Äôai √©crit [un **livre** aux √©ditions ENI](https://www.editions-eni.fr/livre/langage-r-et-statistiques-initiation-a-l-analyse-de-donnees-9782409036934)  
- Tous les mois je fais [un **live sur Twitch**](https://www.twitch.tv/marievaugoyeau/videos) pour parler d‚Äôun package de R, d‚Äôune analyse  
- Je r√©dige une **newsletter** de mani√®re irr√©guli√®re pour parler de mes **inspirations** et transmettre **des trucs et astuces sur R**. Pour s‚Äôy inscrire, [c‚Äôest par l√†](https://d1154691.sibforms.com/serve/MUIEAGj4fIubg6D4qHb7BoZSxNhzkV4p2L0I7GHpNopbqPeDS1J0SpOgaTDCavroygrDTCukB0La-8s1nsQw5wCANT5UP64en1GudsGbKhGVlwbvP_bJdAJ0ECF9BOZ1swRKEnKlnWzTHpLjknJvrCXiH_xw4F_go_2kVB0dWWrkJzRoE22BXImtgVOu29gBxx2hjFkINdeW7Cae?). J‚Äôai aussi [un **blog**](https://mvaugoyeau.netlify.app/fr/) sur lequel vous pourrez retrouver une version de cet article.  
  
Pour en savoir encore un peu plus sur moi, il y a [LinkedIn](https://www.linkedin.com/in/marie-vaugoyeau-72ab64153/) et pour retrouver [tous ces liens et plus encore, c'est ici](https://linktr.ee/mstats)  
  
**N‚Äôh√©sitez pas √† me contacter sur [marie.vaugoyeau@gmail.com](mailto:marie.vaugoyeau@gmail.com) !**  
  
Bonne journ√©e   
  
Marie  
  
![](C:/Users\Marie\Dropbox\Mstats\Img\bandeauSignatureGmail.png)